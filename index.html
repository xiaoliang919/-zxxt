<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>咨询任务管理系统 · 云协作版</title>
  
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* 基础样式与登录界面 */
    #auth-gate{position:fixed;inset:0;background:rgba(15,23,42,.9);display:flex;align-items:center;justify-content:center;z-index:99999;transition:opacity .3s}
    #auth-card{width:380px;max-width:92vw;background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.18);padding:24px; text-align: center;}
    #auth-card h2{margin:0 0 10px;font-size:22px; color: #1e293b; font-weight: 600;}
    .field{display:flex;flex-direction:column;gap:6px;margin:12px 0; text-align: left;}
    .field label {font-size: 14px; color: #475569;}
    .field input{height:40px;border:1px solid #cbd5e1;border-radius:10px;padding:0 12px;outline:none; transition: border-color .2s, box-shadow .2s;}
    .field input:focus {border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);}
    .actions{display:flex;flex-direction: column;gap:10px;margin-top:16px}
    .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600; transition: background-color .2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
    .btn-primary{background:#3b82f6;color:#fff} .btn-primary:hover{background:#2563eb;} .btn-primary:disabled{background:#93c5fd;cursor:not-allowed}
    .btn-ghost{background:#f1f5f9;color:#0f172a} .btn-ghost:hover{background:#e2e8f0;}
    .muted{color:#64748b;font-size:12px; margin-top: 16px;}
    .auth-links { margin-top: 16px; font-size: 14px; display: flex; justify-content: space-between; }
    .auth-links a { color: #3b82f6; text-decoration: none; } .auth-links a:hover { text-decoration: underline; }
    #app-root{display:none}
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900">
  <div id="auth-gate">
    <div id="auth-card">
            <div id="login-view">
        <h2>登录系统</h2>
        <div class="field">
          <label>邮箱</label>
          <input id="login-email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>密码</label>
          <input id="login-pass" type="password" autocomplete="current-password" placeholder="******" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-login">登录</button>
        </div>
        <div class="auth-links">
          <a href="#" id="show-forgot-pass">忘记密码?</a>
          <a href="#" id="show-signup">没有账号? 注册</a>
        </div>
      </div>
            <div id="signup-view" style="display:none;">
        <h2>注册新账号</h2>
        <div class="field">
          <label>邮箱</label>
          <input id="signup-email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>密码</label>
          <input id="signup-pass" type="password" autocomplete="new-password" placeholder="至少6位" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-signup">注册</button>
        </div>
        <p id="signup-msg" class="muted" style="margin-top:10px;"></p>
        <div class="auth-links">
            <a href="#" id="show-login-from-signup">已有账号? 登录</a>
        </div>
      </div>
            <div id="forgot-pass-view" style="display:none;">
        <h2>重置密码</h2>
        <p class="muted" style="margin-top:0; margin-bottom: 10px;">请输入您的邮箱地址，我们将发送重置链接给您。</p>
        <div class="field">
          <label>邮箱</label>
          <input id="forgot-email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-forgot-pass">发送重置链接</button>
        </div>
        <div class="auth-links">
            <a href="#" id="show-login-from-forgot">返回登录</a>
        </div>
      </div>
      <div id="update-password-view" style="display:none;">
        <h2>设置新密码</h2>
        <p class="muted" style="margin-top:0; margin-bottom: 10px;">请输入您的新密码。</p>
        <div class="field">
          <label>新密码</label>
          <input id="update-password-input" type="password" autocomplete="new-password" placeholder="至少6位" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-update-password">更新密码</button>
        </div>
      </div>
      <div id="auth-msg" class="muted"></div>
    </div>
  </div>

  <div id="app-root"></div>

  <script id="supabase-logic">
    (function(){
      const SUPABASE_URL = "https://gpcsknsnwatqqcnywuiv.supabase.co"; 
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY";
      
      if (!window.supabase || !window.supabase.createClient) {
        return alert("Supabase SDK 加载失败，请检查网络连接。");
      }
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      window.supabaseClient = sb;

      // 新增：全局变量，用于存储会话信息
      let authSession = null;

      const $ = (s) => document.querySelector(s);
      const text = (el, t, isError = false) => { 
        if (el) {
          el.textContent = t;
          el.style.color = isError ? '#ef4444' : '#64748b';
        }
      };

      const showView = (viewId) => {
        ['login-view', 'signup-view', 'forgot-pass-view', 'update-password-view'].forEach(id => {
          $( `#${id}`).style.display = (id === viewId) ? 'block' : 'none';
        });
        text($('#auth-msg'), '');
      };

      // 新增：处理密码更新的逻辑
      sb.auth.onAuthStateChange((event, session) => {
        authSession = session;
        if (event === 'PASSWORD_RECOVERY') {
          // 如果是从重置邮件链接过来的，显示更新密码的界面
          showView('update-password-view');
        } else if (session?.user) {
          // 如果用户已登录，则准备启动 React 应用
          const appRoot = document.getElementById('app-root');
          const authGate = document.getElementById('auth-gate');
          if (authGate) authGate.style.display = 'none';
          if (appRoot) appRoot.style.display = 'block';
        } else {
          // 用户未登录，显示登录界面
          showView('login-view');
        }
      });
      
      function handleAuthForms() {
        $('#show-signup').addEventListener('click', (e) => { e.preventDefault(); showView('signup-view'); });
        $('#show-login-from-signup').addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });
        $('#show-forgot-pass').addEventListener('click', (e) => { e.preventDefault(); showView('forgot-pass-view'); });
        $('#show-login-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });

        $('#btn-login').addEventListener('click', async () => {
          const email = $('#login-email').value;
          const password = $('#login-pass').value;
          text($('#auth-msg'), '登录中...');
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if (error) text($('#auth-msg'), `登录失败: ${error.message}`, true);
          // 登录成功后 onAuthStateChange 会自动处理跳转
        });

        $('#btn-signup').addEventListener('click', async () => {
          const email = $('#signup-email').value;
          const password = $('#signup-pass').value;
          text($('#signup-msg'), '注册中...');
          const { error } = await sb.auth.signUp({ email, password });
          if (error) text($('#signup-msg'), `注册失败: ${error.message}`, true);
          else text($('#signup-msg'), '注册成功！请联系管理员激活账号后才能登录。');
        });

        $('#btn-forgot-pass').addEventListener('click', async () => {
          const email = $('#forgot-email').value;
          text($('#auth-msg'), '正在发送...');
          const { error } = await sb.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href.split('#')[0],
          });
          if (error) text($('#auth-msg'), `发送失败: ${error.message}`, true);
          else text($('#auth-msg'), '密码重置链接已发送至您的邮箱，请检查。');
        });

        // 新增：更新密码按钮的点击事件
        $('#btn-update-password').addEventListener('click', async () => {
            const password = $('#update-password-input').value;
            if (!password || password.length < 6) {
                text($('#auth-msg'), '密码长度至少为6位', true);
                return;
            }
            text($('#auth-msg'), '正在更新密码...');
            const { error } = await sb.auth.updateUser({ password: password });

            if (error) {
                text($('#auth-msg'), `更新失败: ${error.message}`, true);
            } else {
                text($('#auth-msg'), '密码更新成功！您现在可以登录了。');
                showView('login-view'); // 更新成功后，跳转回登录界面
            }
        });
      }
      document.addEventListener('DOMContentLoaded', handleAuthForms);
    })();
  </script>

  <script type="text/babel">
    // React部分的逻辑基本不变，但启动逻辑稍作调整
    const { useState, useEffect, useCallback } = React;
    const { createRoot } = ReactDOM;
    const supabase = window.supabaseClient;
    
    // Supabase API 和权限定义... (这部分保持原样)
    const appApi = { /* ... */ }; // 假设这部分代码存在且正确
    
    function App({ session, profile, permissions }) {
      // 您的主应用组件代码在这里...
      // 为了简化，这里只放一个登出按钮和欢迎信息
      const handleLogout = async () => {
            await supabase.auth.signOut();
            window.location.reload(); // 登出后刷新页面
      };

      return (
        <div className="p-4">
            <h1 className="text-2xl font-bold">欢迎, {profile.email}</h1>
            <p className="mt-2">您的角色: {profile.roles.join(', ') || '无'}</p>
            <p className="mt-2">您是管理员: {profile.is_admin ? '是' : '否'}</p>
            <button onClick={handleLogout} className="mt-4 btn btn-primary">退出登录</button>
        </div>
      );
    }

    function AppLoader() {
        const [authState, setAuthState] = useState({ loading: true, data: null });

        useEffect(() => {
          // 由于登录状态现在由外部JS处理，React只需在用户存在时获取数据
          const initApp = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // 此处简化，实际项目中应复用之前的 appApi.getUserProfileAndPermissions
                const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
                if (profile) {
                    // 此处简化权限获取
                    const permissions = { /* ... 您的权限逻辑 ... */ };
                    setAuthState({ loading: false, data: { user: session.user, profile, permissions } });
                } else {
                    // 获取profile失败，登出
                    await supabase.auth.signOut();
                }
            } else {
                setAuthState({ loading: false, data: null });
            }
          };
          initApp();

          // 监听登出事件
          const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                setAuthState({ loading: false, data: null });
            }
          });
          return () => subscription.unsubscribe();
        }, []);
        
        if (authState.loading) return <p>正在加载应用...</p>;

        if (authState.data?.user) {
        // 此处应有您之前的 'pending' 状态检查
        return <App 
                session={authState.data.user} 
                profile={authState.data.profile} 
                permissions={authState.data.permissions} 
            />;
        }

      // 如果没有用户，不渲染任何东西，因为外部JS会显示登录表单
        return null; 
    }
    
    const root = createRoot(document.getElementById('app-root'));
    root.render(<AppLoader />);
  </script>
</body>
</html>
