<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>咨询任务管理系统 · 云协作版</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* 基础样式与登录界面 */
    #auth-gate{position:fixed;inset:0;background:rgba(15,23,42,.9);display:flex;align-items:center;justify-content:center;z-index:99999;transition:opacity .3s}
    #auth-card{width:380px;max-width:92vw;background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.18);padding:24px; text-align: center;}
    #auth-card h2{margin:0 0 10px;font-size:22px; color: #1e293b; font-weight: 600;}
    .field{display:flex;flex-direction:column;gap:6px;margin:12px 0; text-align: left;}
    .field label {font-size: 14px; color: #475569;}
    .field input{height:40px;border:1px solid #cbd5e1;border-radius:10px;padding:0 12px;outline:none; transition: border-color .2s, box-shadow .2s;}
    .field input:focus {border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);}
    .actions{display:flex;flex-direction: column;gap:10px;margin-top:16px}
    .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600; transition: background-color .2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
    .btn-primary{background:#3b82f6;color:#fff} .btn-primary:hover{background:#2563eb;} .btn-primary:disabled{background:#93c5fd;cursor:not-allowed}
    .btn-ghost{background:#f1f5f9;color:#0f172a} .btn-ghost:hover{background:#e2e8f0;}
    .muted{color:#64748b;font-size:12px; margin-top: 16px;}
    .auth-links { margin-top: 16px; font-size: 14px; display: flex; justify-content: space-between; }
    .auth-links a { color: #3b82f6; text-decoration: none; } .auth-links a:hover { text-decoration: underline; }
    #app-root{display:none}
    /* 动画效果 */
    @keyframes pulse-bg { 50% { background-color: rgba(59, 130, 246, 0.2); } }
    .pulse-update { animation: pulse-bg 1.5s ease-in-out; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900">
  <div id="auth-gate">
    <div id="auth-card">
      <div id="login-view">
        <h2>登录系统</h2>
        <div class="field">
          <label>邮箱</label>
          <input id="login-email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>密码</label>
          <input id="login-pass" type="password" autocomplete="current-password" placeholder="******" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-login">登录</button>
        </div>
        <div class="auth-links">
          <a href="#" id="show-forgot-pass">忘记密码?</a>
          <a href="#" id="show-signup">没有账号? 注册</a>
        </div>
      </div>
      <div id="signup-view" style="display:none;">
        <h2>注册新账号</h2>
        <div class="field">
          <label>邮箱</label>
          <input id="signup-email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>密码</label>
          <input id="signup-pass" type="password" autocomplete="new-password" placeholder="至少6位" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-signup">注册</button>
        </div>
        <div class="auth-links">
            <a href="#" id="show-login-from-signup">已有账号? 登录</a>
        </div>
      </div>
      <div id="forgot-pass-view" style="display:none;">
        <h2>重置密码</h2>
        <p class="muted" style="margin-top:0; margin-bottom: 10px;">请输入您的邮箱地址，我们将发送重置链接给您。</p>
        <div class="field">
          <label>邮箱</label>
          <input id="forgot-email" type="email" autocomplete="email" placeholder="you@example.com" />
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-forgot-pass">发送重置链接</button>
        </div>
        <div class="auth-links">
            <a href="#" id="show-login-from-forgot">返回登录</a>
        </div>
      </div>
      <div id="auth-msg" class="muted"></div>
    </div>
  </div>

  <div id="app-root"></div>

  <script id="supabase-logic">
    (function(){
      // ==========================================================
      // !! 关键配置: 请在这里填入您自己的 Supabase 信息 !!
      // ==========================================================
      const SUPABASE_URL = "https://sywrdnnssmuioaidbbhd.supabase.co"; // 替换: 您的 Supabase 项目 URL
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5d3Jkbm5zc211aW9haWRiYmhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzAyMzEsImV4cCI6MjA3MTQwNjIzMX0.FixRnm0iDiejDRWUdcHmPp4p7Qz5vjeG1crZv8HoTDA"; // 替换: 您的 Supabase 项目 Anon Key
      // ==========================================================
      
      if (!window.supabase || !window.supabase.createClient) {
        return alert("Supabase SDK 加载失败，请检查网络连接。");
      }
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      window.supabaseClient = sb;

      const ROLES = ['经理', '前台客服', '部门负责人', '项目负责人', '审核人', '复核人', '办公室'];
      window.ROLES = ROLES;
      
      // 修正：将字段名定义为常量，方便管理
      const ALL_TASK_FIELDS = {
        status: '状态',
        createdAt: '创建时间',
        customTaskId: '任务单号',
        projectName: '项目名称',
        taskType: '任务类型',
        department: '所属部门',
        contractAmount: '合同金额',
        salesPerson: '业务员',
        projectManagerId: '项目负责人',
        auditorId: '审核人',
        recheckerId: '复核人',
        contractualDueDate: '合同约定完成日期',
        actualCompletionDate: '实际完成日期',
        progressDetails: '进展详情',
        isArchived: '是否归档',
        region: '区域'
      };

      // 修正：将视图定义为常量，方便管理
      const VIEW_CONFIG = {
        dashboard: '仪表盘', reviewing: '待审核', assigning: '待分配', inprogress: '进行中', 
        auditing: '审核中', rechecking: '复核中', issuing: '待出具', done: '已完成', 
        void: '已作废', deleted: '已删除', team: '团队管理', settings: '系统设置'
      };

      const PERMISSIONS = {
        '经理': {
          actions: { canCreate: true, canEdit: true, canDelete: true, canVoid: true, canRevert: true, canAssign: true, canSubmit: true, canManageConfig: true, canViewStats: true, canViewDashboard: true, canManageTeam: true },
          visible_fields: Object.keys(ALL_TASK_FIELDS),
          visible_views: ['dashboard', 'reviewing', 'assigning', 'inprogress', 'auditing', 'rechecking', 'issuing', 'done', 'void', 'deleted', 'team', 'settings']
        },
        '前台客服': {
          actions: { canCreate: true, canSubmit: true, canViewDashboard: true },
          visible_fields: ['status', 'createdAt', 'customTaskId', 'projectName', 'taskType', 'department', 'salesPerson'],
          visible_views: ['dashboard', 'reviewing']
        },
        // ... 其他角色权限可以照样写 ...
        'default': { actions: { canViewDashboard: true }, visible_fields: ['status', 'customTaskId', 'projectName'], visible_views: ['dashboard'] }
      };
      window.ALL_TASK_FIELDS = ALL_TASK_FIELDS;
      window.VIEW_CONFIG = VIEW_CONFIG;

      const appApi = {
        async getUserProfileAndPermissions() {
          const { data: { session } } = await sb.auth.getSession();
          if (!session) return { user: null, profile: null, permissions: PERMISSIONS.default };
          
          const { data, error } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
          if (error || !data) {
            console.error("获取用户档案失败:", error);
            await sb.auth.signOut();
            return { user: null, profile: null, permissions: PERMISSIONS.default };
          }

          if (data.status === 'pending') {
             return { user: session.user, profile: data, permissions: PERMISSIONS.default, pending: true };
          }
          
          const profile = data;
          let combinedPermissions = { actions: {}, visible_fields: new Set(), visible_views: new Set() };

          if (profile.is_admin) {
            // 管理员拥有所有权限
            combinedPermissions = PERMISSIONS['经理']; 
          } else {
            (profile.roles || []).forEach(role => {
              const rolePerms = PERMISSIONS[role] || PERMISSIONS.default;
              Object.assign(combinedPermissions.actions, rolePerms.actions);
              rolePerms.visible_fields.forEach(field => combinedPermissions.visible_fields.add(field));
              rolePerms.visible_views.forEach(view => combinedPermissions.visible_views.add(view));
            });
          }
          combinedPermissions.visible_fields = Array.from(combinedPermissions.visible_fields);
          combinedPermissions.visible_views = Array.from(combinedPermissions.visible_views);

          return { user: session.user, profile, permissions: combinedPermissions };
        },
      };
      window.appApi = appApi;

      function handleAuthForms() {
        const $ = (s) => document.querySelector(s);
        const text = (el, t, isError = false) => { 
            if (el) {
                el.textContent = t;
                el.style.color = isError ? '#ef4444' : '#64748b';
            }
        };
        const showView = (viewId) => {
            ['login-view', 'signup-view', 'forgot-pass-view'].forEach(id => {
                $( `#${id}`).style.display = (id === viewId) ? 'block' : 'none';
            });
            text($('#auth-msg'), '');
        };
        $('#show-signup').addEventListener('click', (e) => { e.preventDefault(); showView('signup-view'); });
        $('#show-login-from-signup').addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });
        $('#show-forgot-pass').addEventListener('click', (e) => { e.preventDefault(); showView('forgot-pass-view'); });
        $('#show-login-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });
        $('#btn-login').addEventListener('click', async () => {
          const email = $('#login-email').value;
          const password = $('#login-pass').value;
          text($('#auth-msg'), '登录中...');
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if (error) text($('#auth-msg'), `登录失败: ${error.message}`, true);
        });
        $('#btn-signup').addEventListener('click', async () => {
          const email = $('#signup-email').value;
          const password = $('#signup-pass').value;
          text($('#auth-msg'), '注册中...');
          const { error } = await sb.auth.signUp({ email, password });
          if (error) text($('#auth-msg'), `注册失败: ${error.message}`, true);
          else text($('#auth-msg'), '注册成功！请联系管理员激活您的账号后才能登录。');
        });
        $('#btn-forgot-pass').addEventListener('click', async () => {
          const email = $('#forgot-email').value;
          text($('#auth-msg'), '正在发送...');
          const { error } = await sb.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href.split('#')[0],
          });
          if (error) text($('#auth-msg'), `发送失败: ${error.message}`, true);
          else text($('#auth-msg'), '密码重置链接已发送至您的邮箱，请检查。');
        });
      }
      document.addEventListener('DOMContentLoaded', handleAuthForms);
    })();
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef, Fragment } = React;
    const { createRoot } = ReactDOM;
    const supabase = window.supabaseClient;
    const appApi = window.appApi;
    const ALL_TASK_FIELDS = window.ALL_TASK_FIELDS;
    const VIEW_CONFIG = window.VIEW_CONFIG;
    
    // --- 主应用组件 ---
    function App({ session, profile, permissions }) {
        const [tasks, setTasks] = useState([]);
        const [allProfiles, setAllProfiles] = useState([]);
        const [managementData, setManagementData] = useState({});
        const [isLoading, setIsLoading] = useState(true);
        const [currentView, setCurrentView] = useState('dashboard');
        
        // 初始数据加载
        const fetchData = useCallback(async () => {
            setIsLoading(true);
            try {
                // Fetch tasks and related user profiles in one go
                const { data: tasksData, error: tasksError } = await supabase
                    .from('tasks')
                    // 修正：Supabase JS client v2 会自动将 snake_case 转为 camelCase，所以这里不需要 select 转换
                    .select('*, project_manager:projectManagerId(id, email), auditor:auditorId(id, email), rechecker:recheckerId(id, email)');
                if (tasksError) throw tasksError;
                setTasks(tasksData || []);

                // Fetch all user profiles if the user has permission
                if (permissions.actions.canManageTeam) {
                    const { data: profilesData, error: profilesError } = await supabase.from('profiles').select('*');
                    if (profilesError) throw profilesError;
                    setAllProfiles(profilesData || []);
                }
            } catch (error) {
                console.error("加载数据失败:", error);
                alert(`加载数据失败: ${error.message}`);
            } finally {
                setIsLoading(false);
            }
        }, [permissions.actions.canManageTeam]);

        useEffect(() => {
            fetchData();
        }, [fetchData]);
        
        // 修正：优化实时订阅逻辑
        useEffect(() => {
            const handleDbChange = (payload) => {
                console.log('数据库发生变更:', payload);
                // 推荐的优化方式：在这里根据 payload 的内容精确更新 state
                // 例如：如果是 INSERT，则在 tasks 数组前部增加新任务
                // if (payload.eventType === 'INSERT') {
                //   setTasks(currentTasks => [payload.new, ...currentTasks]);
                // }
                // 暂时先用重新加载作为兜底方案
                alert('数据已更新，将重新加载列表！');
                fetchData();
            };

            const channel = supabase.channel('realtime-tasks')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, handleDbChange)
                .subscribe();

            return () => {
                supabase.removeChannel(channel);
            };
        }, [fetchData]);

        const handleLogout = async () => {
            await supabase.auth.signOut();
        };

        if (isLoading) {
            return (
                <div className="w-screen h-screen flex items-center justify-center">
                    <p className="text-lg text-slate-500 animate-pulse">正在加载系统数据...</p>
                </div>
            )
        }

        return (
            <div className="h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex flex-col">
                <header className="flex-shrink-0 flex flex-wrap items-center justify-between gap-4 p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                    <div>
                        <h1 className="text-xl font-bold">咨询任务管理系统</h1>
                        <p className="text-sm text-slate-500 dark:text-slate-400">
                            {profile.email} ({profile.is_admin ? "管理员" : (profile.roles || []).join(', ')})
                        </p>
                    </div>
                    <div className="flex items-center gap-2">
                         <button onClick={handleLogout} className="btn btn-ghost">退出</button>
                    </div>
                </header>
                
                <div className="flex flex-grow overflow-hidden">
                    <aside className="w-56 bg-white dark:bg-slate-800 p-4 flex-shrink-0 border-r border-slate-200 dark:border-slate-700 overflow-y-auto">
                      <nav className="flex flex-col gap-2">
                            {/* 修正：动态生成侧边栏视图按钮 */}
                        {permissions.visible_views.map(viewKey => (
                                <button 
                                    key={viewKey} 
                                    onClick={() => setCurrentView(viewKey)} 
                                    className={`btn w-full justify-start ${currentView === viewKey ? 'bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300' : 'btn-ghost'}`}
                                >
                                    {VIEW_CONFIG[viewKey] || viewKey}
                                </button>
                            ))}
                        
                        {permissions.actions.canCreate && <button className="btn btn-primary w-full mt-4">创建任务</button>}
                      </nav>
                    </aside>

                    <main className="flex-grow p-6 overflow-y-auto">
                        {currentView === 'dashboard' && (
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-200">欢迎回来, {profile.email}!</h2>
                                <p className="mt-2 text-slate-600 dark:text-slate-400">这是您的个性化仪表盘。</p>
                            </div>
                        )}
                        {currentView === 'team' && (
                             <div>
                                <h2 className="text-2xl font-bold">团队管理</h2>
                                {/* 在这里构建团队管理界面 */}
                            </div>
                        )}
                        {/* 修正：渲染任务列表视图 */}
                        {![ 'dashboard', 'team', 'settings'].includes(currentView) && (
                            <div>
                                <h2 className="text-xl font-bold">任务列表: {VIEW_CONFIG[currentView] || currentView}</h2>
                                <div className="mt-4 bg-white dark:bg-slate-800 rounded-lg shadow overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 dark:bg-slate-700">
                                            <tr>
                                                {permissions.visible_fields.map(fieldKey => 
                                                    <th key={fieldKey} className="p-3 font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap">
                                                        {ALL_TASK_FIELDS[fieldKey] || fieldKey}
                                                    </th>
                                                )}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {tasks.map(task => (
                                                <tr key={task.id} className="border-t border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                                    {/* 修正：直接使用 fieldKey，不再错误地转换大小写 */}
                                                    {permissions.visible_fields.map(fieldKey => 
                                                        <td key={`${task.id}-${fieldKey}`} className="p-3 whitespace-nowrap">
                                                            {task[fieldKey]?.toString() || 'N/A'}
                                                        </td>
                                                    )}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            </div>
        );
    }

    // --- 应用启动器 ---
    function AppLoader() {
        const [authState, setAuthState] = useState({ loading: true, data: null });

        useEffect(() => {
            appApi.getUserProfileAndPermissions().then(data => {
                setAuthState({ loading: false, data });
            });
            const { data: { subscription } } = supabase.auth.onAuthStateChange(
                async (event, session) => {
                    const data = await appApi.getUserProfileAndPermissions();
                    setAuthState({ loading: false, data });
                }
            );
            return () => subscription.unsubscribe();
        }, []);

        useEffect(() => {
            const gate = document.getElementById('auth-gate');
            const app = document.getElementById('app-root');
            if (authState.loading) return;
            if (authState.data && authState.data.user) {
                gate.style.display = 'none';
                app.style.display = 'block';
            } else {
                gate.style.display = 'flex';
                app.style.display = 'none';
            }
        }, [authState]);
        
        if (authState.loading) return null;

        if (authState.data && authState.data.user) {
            if (authState.data.pending) {
                return (
                    <div className="w-screen h-screen flex flex-col items-center justify-center bg-slate-100">
                       <h2 className="text-2xl font-bold mb-4 text-slate-800">账号待审批</h2>
                       <p className="text-slate-600 mb-6">您的账号已注册成功，正在等待管理员激活。请联系管理员。</p>
                       <button onClick={() => supabase.auth.signOut()} className="btn btn-primary">退出登录</button>
                    </div>
                );
            } else {
                return <App 
                    session={authState.data.user} 
                    profile={authState.data.profile} 
                    permissions={authState.data.permissions} 
                />;
            }
        }
        return null;
    }
    
    const root = createRoot(document.getElementById('app-root'));
    root.render(<AppLoader />);
  </script>
</body>
</html>

